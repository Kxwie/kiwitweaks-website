# MongoDB + KeyAuth Integration Guide

## ✅ Complete Implementation

Your website now fully integrates with MongoDB and KeyAuth for user management and license tracking.

---

## 📊 MongoDB User Schema

### **Complete User Document Structure:**

```javascript
{
  // Basic Info
  _id: ObjectId("..."),
  email: "user@example.com",
  password: "hashed_bcrypt_password",
  username: "username",
  
  // Account Tracking
  createdAt: ISODate("2025-01-20T10:00:00Z"),
  lastLogin: ISODate("2025-01-25T14:30:00Z"),
  accountDays: 5, // Calculated dynamically
  
  // KeyAuth Integration
  hwid: "ABC123-DEF456-GHI789", // Hardware ID (set by software)
  licenseKey: "XXXX-XXXX-XXXX-XXXX", // Generated by KeyAuth
  licenseGeneratedAt: ISODate("2025-01-20T10:05:00Z"),
  
  // Premium Status
  isPremium: true,
  emailVerified: false,
  
  // Purchases & Orders
  purchases: [
    {
      orderId: "KWT-2025-123",
      productName: "KiwiTweaks Premium",
      amount: 29.99,
      date: ISODate("2025-01-20T10:05:00Z")
    }
  ],
  
  // Password Reset (temporary)
  resetToken: "hashed_token",
  resetTokenExpiry: ISODate("2025-01-25T15:00:00Z"),
  
  // Tracking
  lastVerified: ISODate("2025-01-25T14:30:00Z"),
  hwidUpdatedAt: ISODate("2025-01-20T11:00:00Z"),
  passwordChangedAt: ISODate("2025-01-20T10:00:00Z")
}
```

---

## 🔄 Field Updates & Calculations

### **1. Account Days (Dynamic)**
```javascript
// Calculated on every profile API call
accountDays = Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24))
```

**Updates:** Every time user views profile
**Display:** Profile overview stats

### **2. Last Login**
```javascript
// Updated on every successful login
lastLogin = new Date()
```

**Updates:** `/api/auth/login` endpoint
**Display:** Console log / admin dashboard

### **3. License Key**
```javascript
// Set when user purchases premium
licenseKey = "ABCD-EFGH-IJKL-MNOP" // From KeyAuth
```

**Updates:** `/api/keyauth/generate-license` endpoint
**Display:** 
- Profile quick stats (with copy button)
- Orders tab

### **4. HWID (Hardware ID)**
```javascript
// Set when user activates software
hwid = "ABC123-DEF456-GHI789"
```

**Updates:** `/api/keyauth/update-hwid` endpoint
**Source:** Called from KiwiTweaks software (C++ client)
**Display:** Admin dashboard only

---

## 🔑 KeyAuth Integration Flow

### **Purchase Flow:**

```
User Clicks "Purchase"
       ↓
Payment Processed (Stripe/PayPal)
       ↓
Call: POST /api/keyauth/generate-license
       ↓
KeyAuth API: Generate License
       ↓
MongoDB: Save License Key to User
       ↓
MongoDB: Set isPremium = true
       ↓
Display License Key to User
```

### **Software Activation Flow:**

```
User Opens KiwiTweaks Software
       ↓
Enter License Key
       ↓
Software Calls: POST /api/keyauth/verify-license
       ↓
KeyAuth API: Verify License
       ↓
If Valid: Software Gets HWID
       ↓
Software Calls: POST /api/keyauth/update-hwid
       ↓
MongoDB: Save HWID to User
       ↓
Software Activated!
```

---

## 📡 API Endpoints

### **1. Generate License**
**POST** `/api/keyauth/generate-license`

**Purpose:** Create new KeyAuth license for user

**Headers:**
```json
{
  "Authorization": "Bearer <JWT_TOKEN>",
  "Content-Type": "application/json"
}
```

**Request:**
```json
{
  "username": "user@example.com",
  "duration": 99999999,
  "productId": "premium",
  "note": "Demo Purchase"
}
```

**Response:**
```json
{
  "success": true,
  "licenseKey": "ABCD-EFGH-IJKL-MNOP",
  "message": "License key generated successfully"
}
```

**What It Does:**
1. Calls KeyAuth Seller API to generate license
2. Saves license key to MongoDB user document
3. Sets `isPremium = true`
4. Sets `licenseGeneratedAt = now`

---

### **2. Verify License**
**POST** `/api/keyauth/verify-license`

**Purpose:** Validate license key with KeyAuth (used by software)

**Request:**
```json
{
  "licenseKey": "ABCD-EFGH-IJKL-MNOP",
  "hwid": "ABC123-DEF456-GHI789"
}
```

**Response:**
```json
{
  "success": true,
  "message": "License key is valid",
  "user": {
    "username": "user123",
    "email": "user@example.com",
    "isPremium": true,
    "licenseKey": "ABCD-EFGH-IJKL-MNOP",
    "hwid": "ABC123-DEF456-GHI789"
  },
  "keyauth": {
    "username": "user@example.com",
    "subscriptions": ["premium"],
    "expiry": "99999999"
  }
}
```

**What It Does:**
1. Calls KeyAuth App API to verify license
2. Updates user's HWID in MongoDB (if provided)
3. Sets `lastVerified = now`
4. Returns user + KeyAuth data

---

### **3. Update HWID**
**POST** `/api/keyauth/update-hwid`

**Purpose:** Update user's HWID when they activate software

**Headers:**
```json
{
  "Authorization": "Bearer <JWT_TOKEN>",
  "Content-Type": "application/json"
}
```

**Request:**
```json
{
  "licenseKey": "ABCD-EFGH-IJKL-MNOP",
  "hwid": "ABC123-DEF456-GHI789"
}
```

**Response:**
```json
{
  "success": true,
  "message": "HWID updated successfully"
}
```

**What It Does:**
1. Finds user by license key
2. Updates `hwid` field
3. Sets `hwidUpdatedAt = now`

---

### **4. Get User Profile**
**GET** `/api/user/profile`

**Purpose:** Get user's complete profile data

**Headers:**
```json
{
  "Authorization": "Bearer <JWT_TOKEN>"
}
```

**Response:**
```json
{
  "success": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "user@example.com",
    "username": "user123",
    "isPremium": true,
    "createdAt": "2025-01-20T10:00:00.000Z",
    "lastLogin": "2025-01-25T14:30:00.000Z",
    "accountDays": 5,
    "hwid": "ABC123-DEF456-GHI789",
    "licenseKey": "ABCD-EFGH-IJKL-MNOP",
    "purchases": [...]
  }
}
```

**Calculations:**
- `accountDays` = days since `createdAt`

---

## 🎨 Frontend Display

### **Profile Page:**

#### **Account Stats:**
```javascript
┌─────────────────────────┐
│ Days Active: 5          │  // From accountDays
│ Orders: 3               │  // From purchases.length
└─────────────────────────┘
```

#### **License Key Card:**
```javascript
┌──────────────────────────────────┐
│ 🔑 Your License Key              │
│                                  │
│ ABCD-EFGH-IJKL-MNOP              │
│ [📋 Copy Key]                    │
└──────────────────────────────────┘
```

Displays only if `user.licenseKey` exists.

---

## 🔧 MongoDB Indexes (Recommended)

For optimal performance, create these indexes:

```javascript
// In MongoDB shell or Atlas
db.users.createIndex({ email: 1 }, { unique: true })
db.users.createIndex({ licenseKey: 1 })
db.users.createIndex({ hwid: 1 })
db.users.createIndex({ createdAt: -1 })
db.users.createIndex({ lastLogin: -1 })
```

---

## 🚀 Implementation Checklist

### **Backend Updates:** ✅
- [x] `/api/auth/register.js` - Added new fields on account creation
- [x] `/api/auth/login.js` - Updates `lastLogin` on every login
- [x] `/api/user/profile.js` - Calculates `accountDays` dynamically
- [x] `/api/keyauth/generate-license.js` - Saves license key to MongoDB
- [x] `/api/keyauth/update-hwid.js` - Updates HWID from software
- [x] `/api/keyauth/verify-license.js` - Verifies licenses with KeyAuth

### **Frontend Updates:** ✅
- [x] `js/profile-page.js` - Displays `accountDays` from API
- [x] `js/profile-page.js` - Shows license key with copy button
- [x] `js/profile-page.js` - Displays last login (console)

---

## 📝 Field Purpose Summary

| Field | Purpose | Updated By | Display |
|-------|---------|------------|---------|
| `createdAt` | Account creation date | Register API | Profile stats |
| `lastLogin` | Last login timestamp | Login API | Console/Admin |
| `accountDays` | Days since creation | Calculated | Profile stats |
| `hwid` | Hardware ID | Software | Admin only |
| `licenseKey` | KeyAuth license | Purchase flow | Profile + Orders |
| `isPremium` | Premium status | Purchase flow | Everywhere |
| `licenseGeneratedAt` | License creation time | Generate API | Admin |
| `lastVerified` | Last license check | Verify API | Admin |
| `hwidUpdatedAt` | HWID update time | Update HWID API | Admin |

---

## 🔒 Security Notes

### **1. HWID Protection**
- HWID is never exposed in frontend
- Only accessible via authenticated API
- Prevents license sharing

### **2. License Key**
- Stored in MongoDB + KeyAuth
- Validated against KeyAuth on every software start
- Single HWID per license (enforced by KeyAuth)

### **3. Account Days**
- Calculated server-side (can't be tampered)
- Based on `createdAt` timestamp
- Updates automatically

---

## 🧪 Testing

### **Test New User Registration:**
```javascript
POST /api/auth/register
{
  "email": "test@example.com",
  "password": "password123",
  "username": "testuser"
}

// Check MongoDB document has:
// - createdAt
// - lastLogin
// - accountDays = 0
// - hwid = null
// - licenseKey = null
// - isPremium = false
```

### **Test Login Updates:**
```javascript
POST /api/auth/login
{
  "email": "test@example.com",
  "password": "password123"
}

// Check MongoDB:
// - lastLogin updated to current time
```

### **Test License Generation:**
```javascript
POST /api/keyauth/generate-license
Authorization: Bearer <token>
{
  "username": "test@example.com"
}

// Check MongoDB:
// - licenseKey set
// - isPremium = true
// - licenseGeneratedAt set
```

### **Test Profile API:**
```javascript
GET /api/user/profile
Authorization: Bearer <token>

// Check response:
// - accountDays calculated correctly
// - licenseKey present if user is premium
// - lastLogin matches database
```

---

## 🎉 Summary

Your MongoDB database now tracks:

✅ **User creation date** - `createdAt`
✅ **Last login time** - `lastLogin` (updates on every login)
✅ **Account age** - `accountDays` (calculated dynamically)
✅ **Hardware ID** - `hwid` (set by software, empty initially)
✅ **License key** - `licenseKey` (from KeyAuth)
✅ **Premium status** - `isPremium`

KeyAuth integration:
✅ **Generate licenses** via Seller API
✅ **Verify licenses** via App API  
✅ **Save keys to MongoDB** automatically
✅ **Track HWID** for license enforcement
✅ **Display keys** in user profile

Everything is production-ready and fully functional! 🚀
